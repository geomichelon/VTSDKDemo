# Android: Using the SDK (FFI) and Sample App

This guide explains how to build and use the Rust FFI SDK on Android, and how the sample app in `android-demo/` is wired.

## Overview

- Rust FFI crate: `ffi/` builds `libvt_sdk_ffi.so` per ABI.
- Public C header: `ffi/include/vt_sdk.h` (generated by `build.rs`).
- Android integration pattern:
  - Place the `.so` files under `app/src/main/jniLibs/<ABI>/`.
  - Add a tiny JNI shim in C/C++ that delegates to the FFI (or call the FFI directly via `System.loadLibrary("vt_sdk_ffi")` if you export JNI symbols yourself).
  - Kotlin object wraps the native methods for app/tests.

## Requirements

- JDK 17, Android Studio (Giraffe+), Android SDK/NDK (r25c recommended).
- Rust toolchain via `rustup`.

## Build the Rust libraries (.so)

1) Add Android targets:
`rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android`

2) Ensure your NDK toolchains are available (CI does this automatically). Locally, you can configure `~/.cargo/config.toml` to point to NDK clang linkers, or install `cargo-ndk` and use it.

3) Build per ABI (real mode):
- `cargo build -p vt-sdk-ffi --release --target aarch64-linux-android` (arm64-v8a)
- `cargo build -p vt-sdk-ffi --release --target armv7-linux-androideabi` (armeabi-v7a)
- `cargo build -p vt-sdk-ffi --release --target x86_64-linux-android` (x86_64)

Outputs:
- `target/<triple>/release/libvt_sdk_ffi.so`

Optional (mock mode): add `--no-default-features --features mock` to each build.

## Copy libraries into your app

Create ABI folders and copy the `.so` files:
- `app/src/main/jniLibs/arm64-v8a/libvt_sdk_ffi.so`
- `app/src/main/jniLibs/armeabi-v7a/libvt_sdk_ffi.so`
- `app/src/main/jniLibs/x86_64/libvt_sdk_ffi.so`

Gradle will package these according to ABI filters.

## JNI shim (sample)

File: `android-demo/app/src/main/cpp/vtsdk_jni.cpp`
- Uses `dlopen/dlsym` to resolve `vt_compare_images` and `vt_free_string` from `libvt_sdk_ffi.so` at runtime.
- Signature exposed to Kotlin:
`Java_com_example_vtsdkdemo_VtSdkFFI_vtCompareImages(...) -> jstring`

Build config: `android-demo/app/src/main/cpp/CMakeLists.txt`.

Kotlin wrapper: `android-demo/app/src/main/java/com/example/vtsdkdemo/VtSdkFFI.kt`
- Loads `vt_sdk_ffi` and `vtsdk_shim`, exposes `vtCompareImages(...)` returning JSON string.

## Sample app UI

Activity: `android-demo/app/src/main/java/com/example/vtsdkdemo/MainActivity.kt`
- Pick two images (Storage Access Framework) OR tap “Prepare Sample Images” to generate demo PNGs.
- Optionally add excluded areas (X, Y, W, H), which are sent to the FFI as JSON:
  `[ { "topLeftX":x, "topLeftY":y, "bottomRightX":x+w-1, "bottomRightY":y+h-1 }, ... ]`
- Tap “Compare Selected” to call the FFI:
  - Displays JSON and highlights `obtainedSimilarity`.
  - Loads the diff image path returned by the core in `resultImageRef`.

## JSON fields (compare)

- `obtainedSimilarity`: float 0–100
- `status`: `Passed`/`Failed` if `min_similarity` was provided
- `resultImageRef`: string path to a diff image (PNG) generated by the core (if available)
- `noiseFilter`: integer echo
- `excludedAreas`: list echo of areas

## Instrumented UI test (sample)

File: `android-demo/app/src/androidTest/java/com/example/vtsdkdemo/UiTests.kt`
- Taps “Prepare Sample Images” and “Compare Selected”.
- Asserts JSON contains `obtainedSimilarity`.

Add test deps in `app/build.gradle`:
- `androidTestImplementation 'androidx.test.ext:junit:1.1.5'`
- `androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'`

Run: `./gradlew connectedDebugAndroidTest` (requires emulator/device).

## CI

- Workflow: `.github/workflows/build-android-sample.yml`
  - Builds Rust `.so` for ABIs, copies into `jniLibs`, runs `assembleDebug`, uploads APK artifact.
- Workflow: `.github/workflows/build-android-so.yml`
  - Only builds and uploads the `.so` libraries + `vt_sdk.h` as artifacts.

## Consume as Android Package (AAR)

Prefer consuming as a Gradle dependency from GitHub Packages. See docs/ANDROID_PACKAGE.md for:
- Maven coordinates (`com.geomichelon:vt-sdk-android:<version>`)
- Repository credentials setup
- Code usage via `com.geomichelon.vtsdk.VtSdkFFI`

## Troubleshooting

- `UnsatisfiedLinkError`: ensure `.so` is present under `jniLibs/<ABI>/` and ABI matches device.
- `No such file or directory` for symbols: verify `System.loadLibrary("vt_sdk_ffi")` and that the JNI shim finds the FFI via `dlopen("libvt_sdk_ffi.so")`.
- Wrong paths: make sure file paths passed to FFI are readable by the app (cache or files directories), not content URIs.
- Performance: prefer pre-scaling images before comparison if very large; the core already normalizes to 256×256 for the metric by default.

## Notes

- `vt_free_string` must be called for strings returned by the FFI after converting to Java/Kotlin strings (the sample JNI shim handles this).
- For production, consider ABI splits and Play delivery per-ABI to reduce APK size.
